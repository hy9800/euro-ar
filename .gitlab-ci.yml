stages:
  - build
  - deploy

variables:
  NODE_ENV: production
  NPM_CONFIG_PRODUCTION: "false"
  APP_PORT: "3001"
  PM2_APP_NAME: "EuroQuest-Next-Ar"
  BRANCH: "master"
  NEXT_TELEMETRY_DISABLE: "1"
  NODE_OPTIONS: "--max-old-space-size=1024"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .next/cache
    - .npm

build:
  stage: build
  image: node:20-bullseye
  script:
    - npm ci --include=dev
    - npm run build
    - mkdir -p out_artifact/.next
    - cp -r .next/standalone out_artifact/
    - mkdir -p out_artifact/.next
    - cp -r .next/static out_artifact/.next/static
    - '[ -d public ] && cp -r public out_artifact/public || true'
    - cp package.json out_artifact/package.json
    - tar -czf app.tgz -C out_artifact .
  artifacts:
    when: on_success
    expire_in: 7 days
    paths:
      - app.tgz

.setup_ssh: &setup_ssh
  image: debian:bookworm-slim
  before_script:
    - DEBIAN_FRONTEND=noninteractive apt-get update -y -qq
    - apt-get install -y --no-install-recommends openssh-client rsync git
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - |
      cat <<EOF > ~/.ssh/config
      Host *
        Port 7822
        StrictHostKeyChecking no
      EOF
    - chmod 600 ~/.ssh/config

deploy:
  stage: deploy
  needs: ["build"]
  <<: *setup_ssh
  script:
    - scp app.tgz "$VPS_USER@$VPS_HOST:/tmp/app.tgz"
    - |
      ssh "$VPS_USER@$VPS_HOST" "bash -lc '
        set -euo pipefail
        mkdir -p \"$VPS_PATH\"
        cd \"$VPS_PATH\"

        ts=\$(date +%Y%m%d%H%M%S)
        mkdir -p releases
        mkdir -p shared
        tar -xzf /tmp/app.tgz -C releases
        mv /tmp/app.tgz /tmp/app.tgz.\$ts

        latest_dir=\$(ls -dt releases/* | head -n1)

        rm -rf .next
        mkdir -p .next
        rsync -a \"\$latest_dir/.next/static/\" .next/static/
        [ -d \"\$latest_dir/public\" ] && rsync -a \"\$latest_dir/public/\" public/ || true

        export NODE_ENV=\"$NODE_ENV\"
        export PORT=\"$APP_PORT\"

        app_root=\"\$latest_dir/standalone\"
        [ -f \"\$app_root/server.js\" ] || (echo \"server.js not found in standalone\" && exit 1)

        pm2 reload \"$PM2_APP_NAME\" --update-env --interpreter=node -- \"\$app_root/server.js\" || \
        pm2 start node --name \"$PM2_APP_NAME\" -- \"\$app_root/server.js\"

        pm2 save
      '"
